<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <rewrite>
            <rules>
                <!-- Geoserver -->
                <rule name="GeoServer Rewrite" enabled="true" stopProcessing="true">
                    <match url="^geoserver/(.*)" />
                    <action type="Rewrite" url="http://localhost:8080/{R:0}" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_FORWARDED_HOST" value="svd1origotstv01.adm.avesta.se" />
                    </serverVariables>
                </rule>

                <!-- OrigoServer -->
                <rule name="OrigoServer Rewrite" enabled="true" stopProcessing="true">
                    <match url="^origoserver/(.*)" />
                    <action type="Rewrite" url="http://localhost:3001/{R:0}" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_FORWARDED_HOST" value="svd1origotstv01.adm.avesta.se" />
                    </serverVariables>
                </rule>


                <!-- Next.js Client -->
                <rule name="OrigoAdmin Client" stopProcessing="true">
                    <match url="^admin(.*)" />
                    <action type="Rewrite" url="http://localhost:3000/{R:1}" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_FORWARDED_HOST" value="svd1origotstv01.adm.avesta.se" />
                    </serverVariables>
                </rule>
                <rule name="Origo_ext" enabled="false">
                    <match url="(geoserver./*)" />
                    <action type="Rewrite" url="https://svd1origotstv01.adm.avesta.se/{R:0}" />
                </rule>
            </rules>
            
            <outboundRules>
                <!-- 1) Omskriv Location för GeoServer-länkar från localhost:8080 -->
                <rule name="Rewrite Location for GeoServer" preCondition="IsRedirect" enabled="true">
                <match serverVariable="RESPONSE_Location" pattern="^http://localhost:8080/(.*)" />
                <action type="Rewrite" value="https://svd1origotstv01.adm.avesta.se/{R:1}" />
                </rule>

                <!-- 2) Omskriv Location för Origo-länkar från localhost:3001 -->
                <rule name="Rewrite Location for Origo" preCondition="IsRedirect" enabled="true">
                <match serverVariable="RESPONSE_Location" pattern="^http://localhost:3001/(.*)" />
                <action type="Rewrite" value="https://svd1origotstv01.adm.avesta.se/{R:1}" />
                </rule>

                <!-- 3) Lämna IdP-länkar helt orörda (ingen regel behövs) -->
                <!-- OBS: Vi lägger till en preCondition som gör att våra regler bara triggar vid redirect-svar -->
                <preConditions>
                    <preCondition name="IsRedirect">
                        <add input="{RESPONSE_Status}" pattern="^3\d\d$" />
                    </preCondition>
                </preConditions>
            </outboundRules>

        </rewrite>

        <!-- MIME types -->
        <staticContent>
            <mimeMap fileExtension=".geojson" mimeType="application/geojson" />
        </staticContent>

        <!-- Disable caching -->
        <caching enabled="false" enableKernelCache="false" />
    </system.webServer>
</configuration>